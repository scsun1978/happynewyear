神州云服 · 企业微信新年红包抽奖 + 小游戏系统

你是 anti-gravity（高级全栈交付型工程智能体）。
你的任务是 从 0 到可上线，为 神州云服 交付一套：

企业微信（移动端）内运行的新年红包抽奖 + 强游戏性小游戏活动系统

该系统需 公平、可审计、不可作弊、员工愿意反复游玩，并能在生产服务器稳定运行。

⸻

0. 基础运行与部署信息（强约束）

0.1 服务器
	•	服务器：root@139.196.115.225:22
	•	登录方式：SSH 证书
	•	私钥路径（在发起方本地）：
/Users/shengchun.sun/.ssh/NCS002.pem

0.2 域名
	•	对外访问域名：
https://happynewyear.ilinkedge.cn
	•	必须支持 HTTPS（给出反向代理与证书接入方案）

0.3 部署方式
	•	必须容器化
	•	提供：
	•	docker-compose.yml
	•	.env.example
	•	一键启动 / 停止 / 回滚脚本
	•	支持服务器冷启动后一条命令恢复服务

⸻

1. 企业微信认证（必须、不可绕过）

1.1 企微基础参数
	•	企业 ID（CORP_ID）：ww112f4f89390a03cd
	•	应用 ID（AGENT_ID）：1000037
	•	Secret：Qb3gx8OKJey-N8N1yUEEGRVk1ig0vxhhfowwtA8eWO8

1.2 认证方式要求
	•	仅允许 企微内访问
	•	流程：
	1.	前端通过企微 JS-SDK / URL 回调获取 code
	2.	后端用 code 换取用户身份（UserId / OpenUserId）
	3.	以 企微 UserId 作为唯一用户主键
	•	会话要求：
	•	HttpOnly Cookie
	•	SameSite
	•	绑定 UA / 设备指纹
	•	需要输出：
	•	企微后台需要配置的：可信域名 / JS-SDK 域名 / 网页授权域名清单

⸻

2. 奖项规则（硬约束，绝不可突破）

2.1 奖项名额
	•	一等奖：1 名
	•	二等奖：2 名
	•	三等奖：3 名
	•	其他：阳光普照奖（不限或可配置上限）

2.2 强制规则
	•	任意时间点：
	•	一等奖 ≤ 1
	•	二等奖 ≤ 2
	•	三等奖 ≤ 3
	•	名额用尽后：
	•	自动不可再中
	•	抽奖结果自动降级
	•	禁止任何人工指定中奖用户
	•	必须使用数据库事务 / 行锁 / 原子更新保证并发安全

⸻

3. 游戏整体设计目标（员工愿意玩）

3.1 设计目标
	•	员工不会“点一下就走”
	•	愿意：
	•	玩 3–5 局
	•	在群里晒截图
	•	抽奖 ≠ 直接点击
必须“先玩 → 再抽”

⸻

4. 游戏玩法设计（必须至少 2 层）

4.1 主玩法：闯关式小游戏（强参与）
	•	单局时长：60–90 秒
	•	示例方向（你可优化但需更好玩）：
	•	“云端红包雨”：
	•	点击红包得分
	•	避开“节点故障 / 炸弹”
	•	连击触发倍数
	•	结算产出：
	•	云力值 / 算力值
	•	抽奖次数（有每日与总上限）

4.2 辅助玩法：任务与留存
	•	每日首次登录：送基础抽奖次数
	•	完成任务：
	•	完成 1 局
	•	达到某评分
	•	可选排行榜（仅影响阳光普照奖次数）

⸻

5. 神州云服品牌与世界观（必须体现）

5.1 品牌定位
	•	公司：神州云服
	•	官网参考：https://www.cloud-service.com.cn/
	•	气质关键词：
	•	云服务
	•	稳定可靠
	•	技术驱动
	•	有年味但不土

5.2 世界观包装（轻量）

每位员工都是一名「云节点工程师」
通过小游戏稳定云端算力
在新年红包池中获取好运

术语包装：
	•	积分 → 云力 / 算力
	•	抽奖 → 云端分配 / 红包调度

⸻

6. 抽奖算法与公平性（必须可审计）

6.1 抽奖原则
	•	抽奖结果 先由后端生成并落库
	•	前端仅播放动画
	•	一二三等奖：
	•	限量池
	•	动态概率
	•	名额硬锁

6.2 审计机制
	•	每次抽奖生成审计记录：
	•	prev_hash
	•	payload
	•	timestamp
	•	server_salt
	•	形成链式哈希，支持导出校验

⸻

7. 反作弊与风控（强制）

必须实现：
	1.	UserId 唯一身份
	2.	抽奖次数完全由后端计算
	3.	接口限流（IP / User / 设备）
	4.	防重放 nonce + timestamp
	5.	并发事务防超发
	6.	管理操作全留痕
	7.	日志密钥打码

⸻

8. 功能模块清单

8.1 员工端（企微 H5）
	•	登录态识别
	•	小游戏
	•	抽奖动画页
	•	我的记录
	•	中奖榜单（脱敏）
	•	规则说明

8.2 管理端
	•	活动配置
	•	奖池名额实时监控
	•	抽奖记录与审计导出
	•	风控异常用户列表
	•	紧急停止开关

⸻

9. 技术要求（建议）
	•	前端：H5（Vue / React）
	•	后端：Node/NestJS 或 Go
	•	DB：MySQL / PostgreSQL
	•	Cache：Redis
	•	反代：Nginx / Caddy
	•	全容器化

⸻

10. 交付物（按顺序输出）

A. PRD（含用户流程）
B. 技术方案（架构 + 表结构 + 核心接口）
C. 反作弊 & 审计设计
D. 部署手册（含企微后台配置）
E. 开发里程碑计划
F. 代码结构说明 + docker-compose